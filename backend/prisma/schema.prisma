// RapidTool-Fixture - Production Schema
// Database: PostgreSQL (Supabase)
// Features: 2-Tier License, Import/Export Tracking, Payment Infrastructure, Error Logging

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserTier {
  FREE      // 5 models limit
  PREMIUM   // Unlimited models
}

enum LicenseType {
  TRIAL
  PAID
}

enum LicenseStatus {
  ACTIVE
  EXPIRED
  SUSPENDED
  CANCELLED
}

enum ImportStatus {
  UPLOADING
  UPLOADED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum ExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  EXPIRED
}

enum ExportFormat {
  STL
  OBJ
  GLTF
  GLB
  THREE_MF
  STEP
  IGES
}

enum ProjectStatus {
  DRAFT
  ACTIVE
  PROCESSING
  COMPLETED
  ARCHIVED
  DELETED
}

enum ErrorSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ErrorCategory {
  IMPORT_ERROR
  PROCESSING_ERROR
  EXPORT_ERROR
  VALIDATION_ERROR
  SYSTEM_ERROR
  NETWORK_ERROR
  PAYMENT_ERROR
  AUTH_ERROR
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  UPI
  NET_BANKING
  WALLET
  RAZORPAY
  STRIPE
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

model User {
  id                       String    @id @default(uuid())
  email                    String    @unique
  passwordHash             String    @map("password_hash")
  emailVerified            Boolean   @default(false) @map("email_verified")
  verificationToken        String?   @map("verification_token")
  verificationTokenExpiry  DateTime? @map("verification_token_expiry")
  passwordResetToken       String?   @map("password_reset_token")
  passwordResetExpiry      DateTime? @map("password_reset_expiry")
  
  // Enhanced Profile Information
  name                     String
  phoneNumber              String?   @map("phone_number")
  organization             String?
  jobTitle                 String?   @map("job_title")
  country                  String?
  industry                 String?
  
  // User Tier & Limits
  tier                     UserTier  @default(FREE)
  modelLimit               Int       @default(5) @map("model_limit")
  modelsUsed               Int       @default(0) @map("models_used")
  
  // User Progress Tracking
  timeSpent                Int       @default(0) @map("time_spent") // Total time in seconds
  maxStepReached           Int       @default(0) @map("max_step_reached") // Highest step completed
  lastSessionFinalStep     Int       @default(0) @map("last_session_final_step") // Last step in previous session
  
  // Security
  failedLoginAttempts      Int       @default(0) @map("failed_login_attempts")
  lockedUntil              DateTime? @map("locked_until")
  mfaEnabled               Boolean   @default(false) @map("mfa_enabled")
  mfaSecret                String?   @map("mfa_secret")
  
  // Profile
  avatarUrl                String?   @map("avatar_url")
  preferences              Json?     @default("{}")
  
  // Timestamps
  createdAt                DateTime  @default(now()) @map("created_at")
  updatedAt                DateTime  @updatedAt @map("updated_at")
  lastLoginAt              DateTime? @map("last_login_at")
  deletedAt                DateTime? @map("deleted_at")
  
  // Relations
  refreshTokens            RefreshToken[]
  license                  License?
  subscription             Subscription?
  projects                 Project[]
  modelImports             ModelImport[]
  exports                  Export[]
  payments                 Payment[]
  errorLogs                ErrorLog[]
  cloudBackups             CloudBackup[]
  sharedProjects           SharedProject[] @relation("SharedBy")
  receivedShares           SharedProject[] @relation("SharedWith")
  auditLogs                AuditLog[]
  numExports               NumExports?
  
  @@index([email])
  @@index([tier])
  @@index([organization])
  @@index([verificationToken])
  @@index([passwordResetToken])
  @@map("users")
}

model RefreshToken {
  id             String    @id @default(uuid())
  userId         String    @map("user_id")
  tokenHash      String    @unique @map("token_hash")
  expiresAt      DateTime  @map("expires_at")
  revoked        Boolean   @default(false)
  revokedAt      DateTime? @map("revoked_at")
  replacedByToken String?  @map("replaced_by_token")
  ipAddress      String?   @map("ip_address")
  userAgent      String?   @map("user_agent")
  createdAt      DateTime  @default(now()) @map("created_at")
  
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// ============================================================================
// LICENSE & SUBSCRIPTION MANAGEMENT
// ============================================================================

model License {
  id              String        @id @default(uuid())
  userId          String        @unique @map("user_id")
  
  // License Type
  licenseType     LicenseType   @map("license_type")
  status          LicenseStatus @default(ACTIVE)
  
  // Dates
  dateStart       DateTime      @map("date_start")
  dateEnd         DateTime?     @map("date_end")
  
  // Timestamps
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  
  // Relations
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([licenseType])
  @@index([status])
  @@index([dateEnd])
  @@map("licenses")
}

model Subscription {
  id                String             @id @default(uuid())
  userId            String             @unique @map("user_id")
  
  // Subscription Details
  tier              UserTier
  status            SubscriptionStatus @default(ACTIVE)
  
  // Billing
  billingCycle      String             @map("billing_cycle") // "monthly", "yearly"
  amount            Float
  currency          String             @default("INR")
  
  // Limits
  modelLimit        Int                @map("model_limit")
  
  // Dates
  startDate         DateTime           @map("start_date")
  endDate           DateTime?          @map("end_date")
  nextBillingDate   DateTime?          @map("next_billing_date")
  cancelledAt       DateTime?          @map("cancelled_at")
  
  // Auto-renewal
  autoRenew         Boolean            @default(true) @map("auto_renew")
  
  // Metadata
  metadata          Json?
  
  // Timestamps
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  
  // Relations
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments          Payment[]
  
  @@index([userId])
  @@index([status])
  @@index([endDate])
  @@index([nextBillingDate])
  @@map("subscriptions")
}

// ============================================================================
// PAYMENT MANAGEMENT (Future Implementation)
// ============================================================================

model Payment {
  id                String        @id @default(uuid())
  userId            String        @map("user_id")
  subscriptionId    String?       @map("subscription_id")
  
  // Payment Details
  amount            Float
  currency          String        @default("INR")
  status            PaymentStatus @default(PENDING)
  paymentMethod     PaymentMethod @map("payment_method")
  
  // Gateway Information
  gatewayProvider   String        @map("gateway_provider") // "razorpay", "stripe"
  gatewayOrderId    String?       @map("gateway_order_id")
  gatewayPaymentId  String?       @map("gateway_payment_id")
  gatewaySignature  String?       @map("gateway_signature")
  
  // Transaction Details
  transactionId     String?       @unique @map("transaction_id")
  receiptUrl        String?       @map("receipt_url")
  invoiceUrl        String?       @map("invoice_url")
  
  // Failure Information
  failureReason     String?       @map("failure_reason")
  failureCode       String?       @map("failure_code")
  
  // Refund Information
  refundedAmount    Float?        @map("refunded_amount")
  refundedAt        DateTime?     @map("refunded_at")
  refundReason      String?       @map("refund_reason")
  
  // Metadata
  metadata          Json?
  
  // Timestamps
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  completedAt       DateTime?     @map("completed_at")
  
  // Relations
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription      Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([subscriptionId])
  @@index([status])
  @@index([gatewayOrderId])
  @@index([transactionId])
  @@index([createdAt])
  @@map("payments")
}

// ============================================================================
// MODEL IMPORT TRACKING (WITH DB STORAGE)
// ============================================================================

model ModelImport {
  id                String        @id @default(uuid())
  userId            String        @map("user_id")
  projectId         String?       @map("project_id")
  
  // File Information
  filename          String
  originalFilename  String        @map("original_filename")
  fileSize          Int           @map("file_size") // in bytes
  fileHash          String?       @map("file_hash") // MD5 or SHA256 for deduplication
  
  // Storage in Database
  modelData         Bytes?        @map("model_data") // Store actual model file in DB (compressed)
  thumbnailData     Bytes?        @map("thumbnail_data") // Store thumbnail in DB
  
  // Import Status
  status            ImportStatus  @default(UPLOADING)
  progress          Int           @default(0) // 0-100
  
  // Processing Information
  processingStartedAt DateTime?   @map("processing_started_at")
  processingCompletedAt DateTime? @map("processing_completed_at")
  processingDuration Int?         @map("processing_duration") // in milliseconds
  
  // Model Metadata
  vertexCount       Int?          @map("vertex_count")
  faceCount         Int?          @map("face_count")
  boundingBox       Json?         @map("bounding_box") // {min: {x,y,z}, max: {x,y,z}}
  dimensions        Json?         // {width, height, depth}
  volume            Float?        // in cubic units
  
  // Validation
  isValid           Boolean       @default(true) @map("is_valid")
  validationErrors  Json?         @map("validation_errors")
  
  // Error Information
  errorMessage      String?       @map("error_message")
  errorCode         String?       @map("error_code")
  
  // Usage Tracking
  countsTowardLimit Boolean       @default(true) @map("counts_toward_limit")
  
  // Timestamps
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  deletedAt         DateTime?     @map("deleted_at")
  
  // Relations
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  project           Project?      @relation(fields: [projectId], references: [id], onDelete: SetNull)
  errorLogs         ErrorLog[]
  
  @@index([userId])
  @@index([projectId])
  @@index([status])
  @@index([fileHash])
  @@index([createdAt])
  @@index([countsTowardLimit])
  @@map("model_imports")
}

// ============================================================================
// PROJECT MANAGEMENT
// ============================================================================

model Project {
  id              String        @id @default(uuid())
  userId          String        @map("user_id")
  
  // Project Info
  name            String
  description     String?
  thumbnailUrl    String?       @map("thumbnail_url")
  
  // Model Info (metadata only)
  modelFilename   String?       @map("model_filename")
  modelFileType   String?       @map("model_file_type")
  modelFileSize   Int?          @map("model_file_size")
  
  // Design Stats
  supportsCount   Int           @default(0) @map("supports_count")
  clampsCount     Int           @default(0) @map("clamps_count")
  hasBaseplate    Boolean       @default(false) @map("has_baseplate")
  
  // Processing Stats
  processingTime  Int?          @map("processing_time") // in milliseconds
  toolingApplied  Json?         @map("tooling_applied") // Array of tools used
  
  // Status
  status          ProjectStatus @default(DRAFT)
  
  // Collaboration
  isPublic        Boolean       @default(false) @map("is_public")
  shareToken      String?       @unique @map("share_token")
  
  // Timestamps
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  lastOpenedAt    DateTime?     @map("last_opened_at")
  completedAt     DateTime?     @map("completed_at")
  deletedAt       DateTime?     @map("deleted_at")
  
  // Relations
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  modelImports    ModelImport[]
  designVersions  DesignVersion[]
  exports         Export[]
  cloudBackups    CloudBackup[]
  sharedProjects  SharedProject[]
  errorLogs       ErrorLog[]
  
  @@index([userId])
  @@index([status])
  @@index([shareToken])
  @@index([updatedAt])
  @@index([createdAt])
  @@map("projects")
}

model DesignVersion {
  id              String    @id @default(uuid())
  projectId       String    @map("project_id")
  versionNumber   Int       @map("version_number")
  
  // Version Info
  name            String?
  description     String?
  thumbnailUrl    String?   @map("thumbnail_url")
  
  // Changes Summary
  changesSummary  String?   @map("changes_summary")
  supportsCount   Int       @default(0) @map("supports_count")
  clampsCount     Int       @default(0) @map("clamps_count")
  
  // Metadata
  isAutoSave      Boolean   @default(false) @map("is_auto_save")
  
  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  createdBy       String?   @map("created_by")
  
  // Relations
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@unique([projectId, versionNumber])
  @@index([projectId])
  @@index([createdAt])
  @@map("design_versions")
}

// ============================================================================
// EXPORT TRACKING (WITH DB STORAGE)
// ============================================================================

model Export {
  id                  String       @id @default(uuid())
  projectId           String       @map("project_id")
  userId              String       @map("user_id")
  
  // Export Info
  format              ExportFormat
  filename            String
  fileSize            Int?         @map("file_size")
  
  // Storage in Database
  exportData          Bytes?       @map("export_data") // Store exported workpiece in DB (compressed)
  fileUrl             String?      @map("file_url") // Optional: External storage URL if needed
  
  // Export Settings
  settings            Json?
  includeSupports     Boolean      @default(true) @map("include_supports")
  includeClamps       Boolean      @default(true) @map("include_clamps")
  includeBaseplate    Boolean      @default(true) @map("include_baseplate")
  
  // Processing
  processingTime      Int?         @map("processing_time") // in milliseconds
  
  // Status
  status              ExportStatus @default(PENDING)
  errorMessage        String?      @map("error_message")

  
  // Export Count Tracking
  numberOfExportsDone Int          @default(1) @map("number_of_exports_done")
  
  // Download Tracking
  downloadCount       Int          @default(0) @map("download_count")
  lastDownloadedAt    DateTime?    @map("last_downloaded_at")
  
  // Timestamps
  createdAt           DateTime     @default(now()) @map("created_at")
  completedAt         DateTime?    @map("completed_at")
  expiresAt           DateTime?    @map("expires_at")
  
  // Relations
  project             Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user                User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  errorLogs           ErrorLog[]
  
  @@index([projectId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([expiresAt])
  @@map("exports")
}

// ============================================================================
// ERROR TRACKING & LOGGING
// ============================================================================

model ErrorLog {
  id              String        @id @default(uuid())
  userId          String?       @map("user_id")
  projectId       String?       @map("project_id")
  modelImportId   String?       @map("model_import_id")
  exportId        String?       @map("export_id")
  
  // Error Information
  category        ErrorCategory
  severity        ErrorSeverity @default(MEDIUM)
  errorCode       String        @map("error_code")
  errorMessage    String        @map("error_message")
  errorStack      String?       @map("error_stack")
  
  // Context
  operation       String        // "import", "process", "export", "payment", etc.
  step            String?       // Specific step where error occurred
  
  // Technical Details
  browserInfo     Json?         @map("browser_info")
  deviceInfo      Json?         @map("device_info")
  
  // Request Context
  url             String?
  method          String?
  statusCode      Int?          @map("status_code")
  
  // User Action
  userAction      String?       @map("user_action") // What user was trying to do
  
  // Resolution
  resolved        Boolean       @default(false)
  resolvedAt      DateTime?     @map("resolved_at")
  resolution      String?
  
  // Metadata
  metadata        Json?
  
  // Timestamp
  createdAt       DateTime      @default(now()) @map("created_at")
  
  // Relations
  user            User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  project         Project?      @relation(fields: [projectId], references: [id], onDelete: SetNull)
  modelImport     ModelImport?  @relation(fields: [modelImportId], references: [id], onDelete: SetNull)
  export          Export?       @relation(fields: [exportId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([projectId])
  @@index([category])
  @@index([severity])
  @@index([createdAt])
  @@index([resolved])
  @@map("error_logs")
}

// ============================================================================
// COLLABORATION & SHARING
// ============================================================================

model SharedProject {
  id             String    @id @default(uuid())
  projectId      String    @map("project_id")
  sharedBy       String    @map("shared_by")
  sharedWith     String?   @map("shared_with")
  
  // Permissions
  permission     String    @default("view")
  
  // Share Type
  shareType      String    @map("share_type")
  shareToken     String?   @unique @map("share_token")
  
  // Status
  accepted       Boolean   @default(false)
  revoked        Boolean   @default(false)
  
  // Timestamps
  createdAt      DateTime  @default(now()) @map("created_at")
  acceptedAt     DateTime? @map("accepted_at")
  revokedAt      DateTime? @map("revoked_at")
  expiresAt      DateTime? @map("expires_at")
  
  // Relations
  project        Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sharedByUser   User      @relation("SharedBy", fields: [sharedBy], references: [id], onDelete: Cascade)
  sharedWithUser User?     @relation("SharedWith", fields: [sharedWith], references: [id], onDelete: Cascade)
  
  @@index([projectId])
  @@index([sharedWith])
  @@index([shareToken])
  @@index([expiresAt])
  @@map("shared_projects")
}

// ============================================================================
// CLOUD BACKUP & STORAGE
// ============================================================================

model CloudBackup {
  id              String    @id @default(uuid())
  projectId       String    @map("project_id")
  userId          String    @map("user_id")
  
  // Backup Data
  backupName      String?   @map("backup_name")
  compressedData  Bytes?    @map("compressed_data")
  fileSize        Int       @map("file_size")
  checksum        String
  
  // Compression
  compressionType String    @default("gzip") @map("compression_type")
  originalSize    Int?      @map("original_size")
  
  // Metadata
  metadata        Json?
  
  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  accessedAt      DateTime? @map("accessed_at")
  
  // Relations
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([projectId])
  @@index([userId])
  @@index([createdAt])
  @@map("cloud_backups")
}

// ============================================================================
// AUDIT LOG (Security & Compliance)
// ============================================================================

model AuditLog {
  id              String    @id @default(uuid())
  userId          String?   @map("user_id")
  
  // Event Data
  action          String
  resource        String?
  resourceId      String?   @map("resource_id")
  
  // Result
  status          String
  errorMessage    String?   @map("error_message")
  
  // Request Context
  ipAddress       String?   @map("ip_address")
  userAgent       String?   @map("user_agent")
  
  // Additional Data
  metadata        Json?
  
  // Timestamp
  createdAt       DateTime  @default(now()) @map("created_at")
  
  // Relations
  user            User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([resource, resourceId])
  @@map("audit_logs")
}

// ============================================================================
// EXPORT COUNT TRACKING (AGGREGATED)
// ============================================================================

model NumExports {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  exports   Int      @default(0)
  updatedAt DateTime @updatedAt @map("updated_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("num_exports")
}